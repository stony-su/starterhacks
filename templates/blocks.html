<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        #blocklyDiv {
            flex: 1;
            width: 100%;
        }

        #runCodeButton {
            height: 40px;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
        }

        #runCodeButton:hover {
            background-color: #45a049;
        }
    </style>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed"></script>
    <script>

        // Define the custom blocks
        Blockly.Blocks['custom_block_start'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Start Block");
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle1'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Convulutional Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle2'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Max Pooling Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle3'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Activation Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle4'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Dropout Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle5'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Average Pooling Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle6'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Flatten Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle7'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Output Layer");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle8'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Middle Block 8");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle9'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Middle Block 9");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle10'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Middle Block 10");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle11'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Model Summary");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_middle12'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Compile Model");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Blocks['custom_block_end'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("Train Model");
                this.setPreviousStatement(true, null);
                this.setColour(120);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        let csv = "";
        // Define the JavaScript code generation for the custom blocks
        javascript.javascriptGenerator.forBlock['custom_block_start'] = function (block, generator) {
            var code = 'start-block, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle1'] = function (block, generator) {
            var code = 'middle-block-1, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle2'] = function (block, generator) {
            var code = 'middle-block-2, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle3'] = function (block, generator) {
            var code = 'middle-block-3, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle4'] = function (block, generator) {
            var code = 'middle-block-4, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle5'] = function (block, generator) {
            var code = 'middle-block-5, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle6'] = function (block, generator) {
            var code = 'middle-block-6, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle7'] = function (block, generator) {
            var code = 'middle-block-7, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle8'] = function (block, generator) {
            var code = 'middle-block-8, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle9'] = function (block, generator) {
            var code = 'middle-block-9, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle10'] = function (block, generator) {
            var code = 'middle-block-10, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle11'] = function (block, generator) {
            var code = 'middle-block-11, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_middle12'] = function (block, generator) {
            var code = 'middle-block-12, ';
            return code;
        };

        javascript.javascriptGenerator.forBlock['custom_block_end'] = function (block, generator) {
            var code = 'end-block, ';
            return code;
        };

        // Initialize Blockly workspace
        function initBlockly() {
            var workspace = Blockly.inject('blocklyDiv', {
                toolbox: document.getElementById('toolbox'),
                grid: {
                    spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true
                }
            });

            // Add event listener to button
            // Add event listener to button
            document.getElementById('runCodeButton').addEventListener('click', function () {
                const jsCode = javascript.javascriptGenerator.workspaceToCode(workspace);
                console.log(jsCode); // Logs the generated code
                console.log('Sending code to backend...');
                try {
                    fetch("http://localhost:5000/compile_model", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code: jsCode })
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                } catch (e) {
                    console.error(e);
                }
            });
            // document.getElementById('runCodeButton').addEventListener('click', function() {
            //     const jsCode = javascript.javascriptGenerator.workspaceToCode(workspace);
            //     console.log("worksplace");
            //     console.log(jsCode); // Logs the generated code
            //     console.log('Running code...');
            //     try {
            //     eval(jsCode); // Executes the generated code
            //     } catch (e) {
            //     console.error(e);
            //     }
            // });
        }

        window.addEventListener('load', initBlockly);
    </script>
</head>

<body>
    <div id="blocklyDiv"></div>
    <button id="runCodeButton">Run Code</button>
    <xml id="toolbox" style="display: none">
        <category name="Custom" colour="120">
            <block type="custom_block_start"></block>
            <block type="custom_block_middle1"></block>
            <block type="custom_block_middle2"></block>
            <block type="custom_block_middle3"></block>
            <block type="custom_block_middle4"></block>
            <block type="custom_block_middle5"></block>
            <block type="custom_block_middle6"></block>
            <block type="custom_block_middle7"></block>
            <block type="custom_block_middle8"></block>
            <block type="custom_block_middle9"></block>
            <block type="custom_block_middle10"></block>
            <block type="custom_block_middle11"></block>
            <block type="custom_block_middle12"></block>
            <block type="custom_block_end"></block>
        </category>
    </xml>
</body>

</html>